{% extends "webgateway/core_html.html" %}
{% load i18n %}

{% comment %}
<!--
  Copyright (C) 2020 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block title %}
    Delete Scripts
{% endblock %}


{% block link %}

    <style type="text/css">

        body {
            font-family: Arial;
            background: #eee;
            margin: 0px;
            padding: 0px;
        }
        div.footer {
            background: #ddd; 
            position:fixed; 
            bottom:0px; left:0px; right:0px;
            padding: 7px;
            border-top: 1px solid #aaa;
            font-size: 80%;
        }
        h3 {
            margin-top: 0px;
            padding-bottom: 10px;
            border-bottom: solid #aaa 1px;
        }
        input[type='text'] {
            border: solid 1px rgba(0,0,0,.2);
            border-top: solid 1px rgba(0,0,0,.3);
            box-shadow: 0 1px 0 white, inset 0 1px 1px rgba(0,0,0,.1);
            border-radius: 2px;
            padding: 5px;
        }
        #spinner {
            display: none;
            margin: -2px 0;
        }

    </style>
{% endblock %}


{% block script %}
    {{ block.super }}
    {% include "webgateway/base/includes/script_src_jquery.html" %}
    {% include "webgateway/base/includes/script_src_popup.html" %}
    {% include "webgateway/base/includes/jquery-ui.html" %}
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.form-3.51.js" %}"></script>
    <link rel="stylesheet" href="{% static "webclient/css/layout.css"|add:url_suffix %}" type="text/css" />
    <link rel="stylesheet" href="{% static "webclient/css/dusty.css"|add:url_suffix %}" type="text/css" media="screen"/>
    <script type="text/javascript">

        $(document).ready(function() {

            // disable submit until file chosen;
            $('#submit').attr('disabled', 'disabled')

            $('#script_form').ajaxForm({
                beforeSubmit: function() {
                    $("#submit").prop("value", "Deleting...");
                    $("#spinner").show();
                    setTimeout(function(){
                        // Don't disable before submit or data not included
                        $("form input").prop("disabled", true);
                    }, 100);
                },
                success: function(data) {
                    // Force reload of scripts on webclient page
                    window.opener.$("#scriptList").empty();
                    $("#spinner").hide();
                    $("#submit").prop("value", "Done");
                    // Close this window on 'OK'
                    OME.confirm_dialog(
                        data.Message, function(){
                            self.close();
                        }, "Delete Scripts",
                        ["OK"], null, 200);
                }
            });
            // Show any error
            $(document).ajaxError(function(e, req, settings, exception) {
                alert(req.responseText);
            });

            // Update UI when script is selected
            $("#scripts").on("change", "input", function() {
                var selected_count = $("#scripts input:checked").length;
                if (selected_count > 0) {
                    $("#submit").removeAttr("disabled");
                } else {
                    $("#submit").attr("disabled", "disabled");
                }
                $("#submit").attr("value", "Delete Script" + (selected_count > 1 ? "s" : ""));
            });

            // Load existing scripts...
            $.getJSON("{% url 'list_scripts' %}?full_path=true", function(data){
                var script_paths = [];

                var get_paths = function(baseDir, script_data) {
                    var html = "";
                    for (var i=0; i<script_data.length; i++) {
                        var li = script_data[i],   // dict of 'name' and 'ul' for menu items OR 'id' for scripts
                            name = li.name;
                        if (li.id) {
                            // we have found a script - add to list
                            script_paths.push(baseDir + '/' + li.name);
                        } else {
                            get_paths(baseDir + '/' + li.name, li.ul);
                        }
                    }
                    return html;
                };

                get_paths('', data);

                var select_html = script_paths.map(function(f){
                    return "<label><input type='checkbox' name='script_path' value='" + f + "' />" + f + "</label><br/>";
                }).join("");
                $("#scripts").html(select_html);
            })
        });
    </script>
{% endblock %}


{% block body %}
    <form id='script_form' method="post" action="{% url 'script_delete' %}">{% csrf_token %}
        <div style="padding:10px; margin-bottom:40px">
            <h3>Delete Scripts</h3>

            <p id="scripts">
            </p>

        </div>
        <div class="footer">
            <div style="float:right">
                <a href="#" tabIndex="3" onClick="self.close()">Close</a>
                <input id="submit" tabIndex="2" type="submit" value="Delete Script" />
                <img id="spinner" src ="{% static "webgateway/img/spinner.gif" %}"/>
            </div>
        </div>
    </form>
{% endblock %}
