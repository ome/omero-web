{% extends "webclient/base/base_container.html" %}
{% load i18n %}
{% load common_filters %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webgateway/css/ome.table.css"|add:url_suffix %}" type="text/css" media="screen"/>
{% endblock %}

{% block script %}
{{ block.super }}

<style>
    .and_clause {
        border: solid #aaa 1px;
        padding: 5px;
        border-radius: 5px;
        margin: 5px 0;
    }
    .form-row {
        display: flex;
        align-items: end;
    }
    .form-row div {
        flex: 1;
        padding: 2px;
    }
    .search_panel select.keyFields {
        width: 100%;
        height: 22px;
        max-width: 100%;
    }
    #dataTable {
        width: 1200px;
    }
    #dataTable td, #dataTable th {
        font-size: 12px;
        vertical-align: middle;
        padding: 2px;
    }
    #dataTable img {
        height: 64px;
    }
    #doElasticSearch {
        float: right;
        margin: 13px;
    }
    .valueFields {
        width: calc(100% - 8px);
    }
    .no-border {
        background: none;
        border: none;
    }
    #addAND {
        margin: 0 10px;
    }
    #search_form {
        padding: 5px;
    }
</style>

<script type="text/javascript">

let elasticsearch_url = "{{ elasticsearch_url }}";
let thumbUrl = WEBCLIENT.URLS.webindex + "render_thumbnail/";

// TO RUN LOCALLY
// thumbUrl = "https://idr-testing.openmicroscopy.org/webclient/render_thumbnail/";

function initAutoComplete($parent) {
    let $this = $(".valueFields", $parent);
    // key is updated when user starts typing, also used to handle response and select
    let key;
    $this.autocomplete({
        autoFocus: false,
        delay: 1000,
        source: function (request, response) {
            // Need to know what Attribute is of adjacent <select>
            key = $(".keyFields", $parent).val();
            console.log("key...", key);
            let url = `${elasticsearch_url}get_values/?key=${ key }&resource=image`;
            // 'Any' uses different query
            if (key == "Any") {
                url = `${elasticsearch_url}searchusingvaluesonly/?value=${request.term}&resource=image`;
            }
            // showSpinner();
            $.ajax({
                dataType: "json",
                type: 'GET',
                url: url,
                success: function (data) {
                    // hideSpinner();
                    console.log(data);
                    let results = [{ label: 'No results found.', value: -1 }]
                    if (key == "Any" && data.results.length > 0) {
                        results = data.results.map(result => {
                            return {
                                key: result.Attribute,
                                label: `<b>${result.Value}</b> (${result.Attribute}) <span style="color:#bbb">${result["Number of images"]}</span>`,
                                value: `${result.Value}`
                            }
                        })
                    } else {
                        // We need to filter by input text
                        let input = request.term.toLowerCase();
                        results = data.filter(term => term.toLowerCase().includes(input));
                    }
                    response(results);
                },
                error: function (data) {
                    console.log("ERROR", data);
                    // hideSpinner();
                    response([{ label: 'Failed to load', value: -1 }]);
                }
            });
        },
        minLength: 3,
        open: function () { },
        close: function () {
            // $(this).val('');
            return false;
        },
        focus: function (event, ui) { },
        select: function (event, ui) {
            console.log("select", ui.item, key == "Any");
            if (ui.item.value == -1) {
                // Ignore 'No results found'
                return false;
            }
            if (key == "Any") {
                // Use 'key' to update KeyField
                setKeyField($parent, ui.item.key);
            }
            return true;
        }
    }).data("ui-autocomplete")._renderItem = function (ul, item) {
        return $("<li>")
            .append("<a style='font-size:14px; width:245px'>" + item.label + "</a>")
            .appendTo(ul);
    }
}

function get_current_query(){
    and_conditions=[];
    or_conditions=[];

    let queryandnodes = document.querySelectorAll('#search_form .and_clause');
    for (let i=0; i<queryandnodes.length; i++) {

        query_dict={};
        let node = queryandnodes[i];
        // handle each OR...
        let ors = node.querySelectorAll(".form-row");

        let or_dicts = [...ors].map(orNode => {
            return {
                "name": orNode.querySelector(".keyFields").value,
                "value": orNode.querySelector(".valueFields").value,
                "operator": "equals",    // orNode.querySelector(".condition").value,
                "resource": "image",     // get_resource( orNode.querySelector(".keyFields").value),
                "query_type": "keyvalue"
            }
        });
        if (or_dicts.length > 1) {
            or_conditions.push(or_dicts);
        } else {
            and_conditions.push(or_dicts[0]);
        }
    }

    let query_details = {}
    query_details["and_filters"] = and_conditions;
    query_details["or_filters"] = or_conditions;
    query_details["case_sensitive"]=false;

    var query = {
        "query_details": query_details,
        "main_attributes": { 
            "or_main_attributes": []
        }
    };
    return {"query": query};
}

function displayResults(results) {
    console.log("displayResults", results);
    // TODO: check how errors are handled
    // if (results.Error && results.Error != "none") {
    //     $("#dataTable").html(`<tr><td>${results.Error}</td></tr>`);
    //     return;
    // }

    // Need to build columns from each result?
    // let visibleCols = results.columns_def.filter(col => !col.hide);
    let results_array = results?.results?.results;
    if (!results_array) {
        alert("No results");
    }
    // Use first result to get column names from key_values...
    let columnNames = [];
    results_array[0].key_values.forEach(kv => {
        if (columnNames.indexOf(kv.name) == -1) {
            columnNames.push(kv.name);
        }
    });

    // Do we need to check for other column names from ALL results??
    results_array.forEach(r => {
        r.key_values.forEach(kv => {
            if (columnNames.indexOf(kv.name) === -1) {
                alert("adding column from later result: " + kv.name);
                columnNames.push(kv.name);
            }
        });
    });

    // Build a list of dicts from results...
    const result_objs = results_array.map(r => {
        let obj = {id: r.id};
        r.key_values.forEach(kv => {
            if (!obj[kv.name]) {
                obj[kv.name] = kv.value;
            } else {
                // handle duplicates for a column
                obj[kv.name] = obj[kv.name] + "; " + kv.value;
            }
        });
        return obj;
    });

    console.log("columnNames", columnNames)

    let thead = `<th>${new Intl.NumberFormat().format(results.results.size)} Images</th>`;
    thead += columnNames.map(col => `<th>${col}</th>`).join("");
    let tbody = result_objs.slice(0,100).map(row => {
        let thumb = `<td><img loading="lazy" src="${thumbUrl}${ row.id }/" /></td>`;
        let tds = columnNames.map(col => `<td>${row[col]}</td>`).join("");
        // let tds = row.key_values.map(kv => `<td>${kv.value}</td>`).join("");
        return `<tr id="image-${ row.id }">${thumb}${ tds }</tr>`;
    }).join('\n');

    let table = `
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
    `
    $("#dataTable").html(table);
}

async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });
  return response.json();
}

async function submitQuery() {
    let submitqueryurl = elasticsearch_url + "api/v1/resources/image/searchannotation/";
    let searchQuery = get_current_query();
    console.log("searchQuery", searchQuery)
    const data = await postData(submitqueryurl, searchQuery);
    displayResults(data);
}

async function loadSearchTerms() {

    let url = elasticsearch_url + "searchterms";
    // NB: this is not provided by omero_search_engine yet. Need to use omero_search_engine_client
    url = "https://idr-testing.openmicroscopy.org/searchengine/searchterms"
    let searchterms = await fetch(url).then(rsp => rsp.json())
        .catch(error => {
            console.log("Failed to load searchterms", error);
        });

    let options = searchterms.image.sort().map(term => `<option value="${term}">${term}</option>`).join("\n");
    $(".keyFields").append($(options));
}

async function setKeyField($parent, key) {
    // Adds the Key as an <option> to the <select> if not there;
    let $select = $(".keyFields", $parent);
    if ($(`option[value='${key}']`, $select).length == 0) {
        $select.append($(`<option value="${key}">${key}</option>`));
    }
    $select.val(key);
}

function addAnd(attribute, operator, value) {
    let $form = $("#search_form");
    if ($form.children().length > 0) {
        $form.append("<div>AND</div>");
    }
    let $newRow = $andClause.clone();
    $form.append($newRow);
    hideRemoveIfOnlyOneLeft();

    // enable auto-complete
    initAutoComplete($newRow);
}

// Hide the X button if there's only 1 in the form
function hideRemoveIfOnlyOneLeft() {
    let $btns = $("button.remove");
    if ($btns.length == 1) {
        $btns.css('visibility', 'hidden');
    } else {
        $btns.css('visibility', 'visible');
    }
}

let andClause;

$(document).ready(async function() {

    await loadSearchTerms();

    // clone empty form row before any changes
    // used for building form
    $andClause = $("#search_form .and_clause").clone();

    // bind events when page loads...
    {% if init.query %}
        // query field is already populated with init.query
        let query = "{{ init.query }}";
        console.log("query", query);
        if (query && query.includes(":")) {
            let kv = query.split(":");
            setKeyField($(".and_clause"), kv[0]);
            $(".valueFields").val(kv[1]);
        }
        submitQuery();
    {% endif %}

    // single click handler on image (container). Selection then update toolbar & metadata pane
    $("#dataTable").on('click', 'tr', function(event) {
        // uses <tr id='image-1'> to select corrent images etc.
        OME.handleTableClickSelection(event);
    });

    // for the first row in the form
    initAutoComplete($(".and_clause"));

    // ADD button
    $("#addAND").on("click", function(){
        addAnd();
    });
    // Remove button(s)
    // X buttons
    $("#search_form").on("click", ".remove", function (event) {
        let $row = $(this).closest(".form-row");
        let $clause = $row.parent();
        $row.remove();
        // If no rows left, remove clause...
        if ($(".form-row", $clause).length === 0) {
            let $and = $clause.prev();
            if ($and.length == 0) {
                // in case we're removing the first row
                $and = $clause.next();
            }
            $and.remove();
            $clause.remove();
        }
        hideRemoveIfOnlyOneLeft();
    });

    $("#doElasticSearch").on("click", function() {
        submitQuery();
    });

});
</script>

{% endblock %}

{% block left %}

<div id="searching">

    <form id="search_form" class="search_panel standard_form">

        <div class="and_clause">
            <div class="form-row">
                <div>
                    <label>Attribute</label><br>
                    <select class="keyFields">
                        <option value="Any">Any</option>
                    </select>
                </div>
                <div>
                    <label>Value</label><br>
                    <input class="search valueFields" name="query" value="" size="25"/>
                </div>
                <button class="remove no-border" style="margin-bottom: 8px; visibility: hidden">
                    X
                </button>
            </div>
        </div>
    </form>
    <button id="addAND" type="button" class="no-border" title="Add an 'AND' clause to the query">
        add AND
    </button>
    <button id="doElasticSearch">Search</button>

</div>

{% endblock %}

{% block center %}

	<div id="center_panel_header" >
		
		<form class="search filtersearch searchresult_filter" id="filtersearch" action="#" style="display:none">
		    <div>
		        <label for="id_search">
		            Filter Results
		        </label>
			    <input type="text" id="id_search" size="25" />
			</div>
			<!-- <span class="loading">
				<img class="loader" alt="Loading" src="{% static "webgateway/img/spinner.gif" %}">
			</span> -->
		</form>
		<ul style="position: relative; left: 200px; width: 300px; top: 12px; font-size:110%">
            <li id="searchResultCount"></li>
        </ul>
	</div>

	<div id="content_details" class="center_panel_content">
        <table id="dataTable" class="tablesorter"></table>
    </div>

{% endblock %}
